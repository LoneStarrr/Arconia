package lonestarrr.arconia.data.recipes;

import com.google.gson.JsonArray;
import com.google.gson.JsonObject;
import com.google.gson.JsonPrimitive;
import com.mojang.serialization.Dynamic;
import com.mojang.serialization.JsonOps;
import lonestarrr.arconia.common.Arconia;
import lonestarrr.arconia.common.block.ModBlocks;
import lonestarrr.arconia.common.core.BlockNames;
import lonestarrr.arconia.common.core.ItemNames;
import lonestarrr.arconia.common.core.RainbowColor;
import lonestarrr.arconia.common.crafting.ModRecipeTypes;
import lonestarrr.arconia.common.item.ColoredRoot;
import lonestarrr.arconia.common.item.ModItems;
import net.minecraft.core.Registry;
import net.minecraft.data.DataGenerator;
import net.minecraft.data.recipes.FinishedRecipe;
import net.minecraft.data.recipes.RecipeProvider;
import net.minecraft.nbt.CompoundTag;
import net.minecraft.nbt.NbtOps;
import net.minecraft.nbt.Tag;
import net.minecraft.resources.ResourceLocation;
import net.minecraft.world.item.Item;
import net.minecraft.world.item.ItemStack;
import net.minecraft.world.item.Items;
import net.minecraft.world.item.crafting.Ingredient;
import net.minecraft.world.item.crafting.RecipeSerializer;
import net.minecraft.world.level.ItemLike;
import net.minecraft.world.level.block.Blocks;
import org.jetbrains.annotations.NotNull;

import javax.annotation.Nullable;
import java.util.Arrays;
import java.util.function.Consumer;

/**
 * Registers recipes specific for the pedestal crafting ritual
 */
public class PedestalProvider extends RecipeProvider {

    public PedestalProvider(DataGenerator gen) {
        super(gen);
    }

    @Override
    public String getName() {
        return "Arconia pedestal recipes";
    }

    @Override
    protected void buildCraftingRecipes(Consumer<FinishedRecipe> consumer) {
        registerColoredRootRecipes(consumer);
        registerArconiumIngotRecipes(consumer);
        registerInfiniteGoldArconiumBlocks(consumer);
        registerMisc(consumer);
    }

    /*
     * Recipes for colored roots with nbt data on them indicating what item will be generated by the mod's resource generator
     */
    private void registerColoredRootRecipes(Consumer<FinishedRecipe> consumer) {
        final Ingredient clover = Ingredient.of(ModItems.fourLeafClover.get());

        int durationTicks = 60; // Time for ritual to create the item from the recipe
        int count = 1; // Number of items to generate per resource generation event
        RainbowColor tier = RainbowColor.RED;

        consumer.accept(
                makeEnchantedColoredRoot(tier, ModItems.getArconiumEssence(tier).get(), durationTicks, count, clover, clover,
                        Ingredient.of(ModBlocks.getArconiumTreeSapling(tier).get().asItem()), Ingredient.of(
                                RainbowColor.woolByTier(tier))));
        consumer.accept(makeEnchantedColoredRoot(tier, ModItems.getArconiumIngot(tier).get(), durationTicks, count, clover, clover,
                Ingredient.of(ModBlocks.getArconiumBlock(tier).get().asItem())));
        for (Item item : new Item[]{Items.OAK_LOG, Items.DARK_OAK_LOG, Items.BIRCH_LOG, Items.JUNGLE_LOG, Items.ACACIA_LOG, Items.SPRUCE_LOG, Items.MANGROVE_LOG, Items.SAND, Items.GRAVEL, Items.DIRT, Items.KELP}) {
            consumer.accept(makeEnchantedColoredRoot(tier, item, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                    Ingredient.of(item)));
        }

        RainbowColor previousTier = tier;
        tier = RainbowColor.ORANGE;

        consumer.accept(
                makeEnchantedColoredRoot(tier, ModItems.getArconiumEssence(tier).get(), durationTicks, count, clover, clover,
                        Ingredient.of(ModBlocks.getArconiumTreeSapling(tier).get().asItem()), Ingredient.of(
                                RainbowColor.woolByTier(tier))));
        consumer.accept(makeEnchantedColoredRoot(tier, ModItems.getArconiumIngot(tier).get(), durationTicks, count, clover, clover,
                Ingredient.of(ModBlocks.getArconiumBlock(tier).get().asItem())));
        for (Item item : new Item[]{Items.ORANGE_DYE, Items.COAL, Items.STONE, Items.DEEPSLATE, Items.DIORITE, Items.GRANITE, Items.ANDESITE, Items.STRING, Items.BEEF, Items.SUGAR_CANE, Items.CHICKEN, Items.RAW_COPPER, Items.WHEAT, Items.MUTTON, Items.COD, Items.SALMON}) {
            consumer.accept(makeEnchantedColoredRoot(tier, item, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                    Ingredient.of(item)));
        }

        previousTier = tier;
        tier = RainbowColor.YELLOW;

        consumer.accept(
                makeEnchantedColoredRoot(tier, ModItems.getArconiumEssence(tier).get(), durationTicks, count, clover, clover,
                        Ingredient.of(ModBlocks.getArconiumTreeSapling(tier).get().asItem()), Ingredient.of(
                                RainbowColor.woolByTier(tier))));
        consumer.accept(makeEnchantedColoredRoot(tier, ModItems.getArconiumIngot(tier).get(), durationTicks, count, clover, clover,
                Ingredient.of(ModBlocks.getArconiumBlock(tier).get().asItem())));
        for (Item item : new Item[]{Items.YELLOW_DYE, Items.RAW_IRON, Items.ARROW, Items.LEATHER, Items.PORKCHOP, Items.FEATHER, Items.BONE_BLOCK, Items.CALCITE, Items.ROTTEN_FLESH, Items.WHITE_WOOL, Items.POTATO, Items.BEETROOT, Items.CARROT, Items.CACTUS, Items.PUMPKIN, Items.MELON}) {
            consumer.accept(makeEnchantedColoredRoot(tier, item, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                    Ingredient.of(item)));
        }

        previousTier = tier;
        tier = RainbowColor.GREEN;

        consumer.accept(
                makeEnchantedColoredRoot(tier, ModItems.getArconiumEssence(tier).get(), durationTicks, count, clover, clover,
                        Ingredient.of(ModBlocks.getArconiumTreeSapling(tier).get().asItem()), Ingredient.of(
                                RainbowColor.woolByTier(tier))));
        consumer.accept(makeEnchantedColoredRoot(tier, ModItems.getArconiumIngot(tier).get(), durationTicks, count, clover, clover,
                Ingredient.of(ModBlocks.getArconiumBlock(tier).get().asItem())));
        for (Item item : new Item[]{Items.GREEN_DYE, Items.RAW_GOLD, Items.LAPIS_LAZULI, Items.REDSTONE, Items.GUNPOWDER, Items.AMETHYST_SHARD}) {
            consumer.accept(makeEnchantedColoredRoot(tier, item, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                    Ingredient.of(item)));
        }

        previousTier = tier;
        tier = RainbowColor.LIGHT_BLUE;

        consumer.accept(
                makeEnchantedColoredRoot(tier, ModItems.getArconiumEssence(tier).get(), durationTicks, count, clover, clover,
                        Ingredient.of(ModBlocks.getArconiumTreeSapling(tier).get().asItem()), Ingredient.of(
                                RainbowColor.woolByTier(tier))));
        consumer.accept(makeEnchantedColoredRoot(tier, ModItems.getArconiumIngot(tier).get(), durationTicks, count, clover, clover,
                Ingredient.of(ModBlocks.getArconiumBlock(tier).get().asItem())));
        for (Item item : new Item[]{Items.LIGHT_BLUE_DYE, Items.DIAMOND, Items.OBSIDIAN, Items.ENDER_PEARL, Items.PRISMARINE_SHARD, Items.PRISMARINE_CRYSTALS,}) {
            consumer.accept(makeEnchantedColoredRoot(tier, item, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                    Ingredient.of(item)));
        }
        consumer.accept(
                makeEnchantedColoredRoot(tier, Items.EXPERIENCE_BOTTLE, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                        Ingredient.of(Items.ENCHANTING_TABLE)));

        previousTier = tier;
        tier = RainbowColor.BLUE;

        consumer.accept(
                makeEnchantedColoredRoot(tier, ModItems.getArconiumEssence(tier).get(), durationTicks, count, clover, clover,
                        Ingredient.of(ModBlocks.getArconiumTreeSapling(tier).get().asItem()), Ingredient.of(
                                RainbowColor.woolByTier(tier))));
        consumer.accept(makeEnchantedColoredRoot(tier, ModItems.getArconiumIngot(tier).get(), durationTicks, count, clover, clover,
                Ingredient.of(ModBlocks.getArconiumBlock(tier).get().asItem())));
        for (Item item : new Item[]{Items.BLUE_DYE, Items.NETHERRACK, Items.SOUL_SAND, Items.SOUL_SOIL, Items.BLAZE_ROD, Items.CRIMSON_STEM, Items.WARPED_STEM, Items.EMERALD, Items.NETHER_WART, Items.BLACKSTONE, Items.BASALT, Items.WITHER_SKELETON_SKULL}) {
            consumer.accept(makeEnchantedColoredRoot(tier, item, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                    Ingredient.of(item)));
        }

        previousTier = tier;
        tier = RainbowColor.PURPLE;

        consumer.accept(
                makeEnchantedColoredRoot(tier, ModItems.getArconiumEssence(tier).get(), durationTicks, count, clover, clover,
                        Ingredient.of(ModBlocks.getArconiumTreeSapling(tier).get().asItem()), Ingredient.of(
                                RainbowColor.woolByTier(tier))));
        consumer.accept(makeEnchantedColoredRoot(tier, ModItems.getArconiumIngot(tier).get(), durationTicks, count, clover, clover,
                Ingredient.of(ModBlocks.getArconiumBlock(tier).get().asItem())));
        for (Item item : new Item[]{Items.PURPLE_DYE, Items.END_STONE, Items.CHORUS_FRUIT, Items.GHAST_TEAR, Items.SHULKER_SHELL, Items.ECHO_SHARD, Items.NETHER_STAR}) {
            consumer.accept(makeEnchantedColoredRoot(tier, item, durationTicks, count, Ingredient.of(ModItems.getArconiumIngot(tier).get()), clover,
                    Ingredient.of(item)));
        }
    }

    private void registerArconiumIngotRecipes(Consumer<FinishedRecipe> consumer) {
        Ingredient clover = Ingredient.of(ModItems.fourLeafClover.get());
        RainbowColor color = RainbowColor.RED;
        Ingredient essence = Ingredient.of(ModItems.getArconiumEssence(color).get());

        consumer.accept(
                new PedestalFinishedRecipe(
                        id(color.getTierName() + ItemNames.ARCONIUM_INGOT_SUFFIX),
                        new ItemStack(ModItems.getArconiumIngot(color).get().asItem()),
                        60,
                        Ingredient.of(Items.RED_DYE),
                        Ingredient.of(Items.RED_DYE),
                        Ingredient.of(Items.RED_DYE),
                        Ingredient.of(Items.RED_DYE),
                        essence,
                        essence,
                        essence,
                        clover
                )
        );

        color = RainbowColor.ORANGE;
        essence = Ingredient.of(ModItems.getArconiumEssence(color).get());
        consumer.accept(
                new PedestalFinishedRecipe(
                        id(color.getTierName() + ItemNames.ARCONIUM_INGOT_SUFFIX),
                        new ItemStack(ModItems.getArconiumIngot(color).get().asItem()),
                        60,
                        Ingredient.of(Items.RAW_COPPER),
                        Ingredient.of(Items.RAW_COPPER),
                        Ingredient.of(Items.STRIPPED_ACACIA_LOG),
                        Ingredient.of(Items.PUMPKIN),
                        essence,
                        essence,
                        essence,
                        clover
                )
        );

        color = RainbowColor.YELLOW;
        essence = Ingredient.of(ModItems.getArconiumEssence(color).get());
        consumer.accept(
                new PedestalFinishedRecipe(
                        id(color.getTierName() + ItemNames.ARCONIUM_INGOT_SUFFIX),
                        new ItemStack(ModItems.getArconiumIngot(color).get().asItem()),
                        60,
                        Ingredient.of(Items.RAW_GOLD),
                        Ingredient.of(Items.DANDELION),
                        Ingredient.of(Items.YELLOW_CONCRETE),
                        Ingredient.of(Items.HAY_BLOCK),
                        essence,
                        essence,
                        essence,
                        clover
                )
        );

        color = RainbowColor.GREEN;
        essence = Ingredient.of(ModItems.getArconiumEssence(color).get());
        consumer.accept(
                new PedestalFinishedRecipe(
                        id(color.getTierName() + ItemNames.ARCONIUM_INGOT_SUFFIX),
                        new ItemStack(ModItems.getArconiumIngot(color).get().asItem()),
                        60,
                        Ingredient.of(Items.EMERALD),
                        Ingredient.of(Items.EMERALD),
                        Ingredient.of(Items.WAXED_WEATHERED_COPPER),
                        Ingredient.of(Items.MELON),
                        essence,
                        essence,
                        essence,
                        clover
                )
        );

        color = RainbowColor.LIGHT_BLUE;
        essence = Ingredient.of(ModItems.getArconiumEssence(color).get());
        consumer.accept(
                new PedestalFinishedRecipe(
                        id(color.getTierName() + ItemNames.ARCONIUM_INGOT_SUFFIX),
                        new ItemStack(ModItems.getArconiumIngot(color).get().asItem()),
                        60,
                        Ingredient.of(Items.DIAMOND),
                        Ingredient.of(Items.DIAMOND),
                        Ingredient.of(Items.OBSIDIAN),
                        Ingredient.of(Items.BLUE_ICE),
                        essence,
                        essence,
                        essence,
                        clover
                )
        );

        color = RainbowColor.BLUE;
        essence = Ingredient.of(ModItems.getArconiumEssence(color).get());
        consumer.accept(
                new PedestalFinishedRecipe(
                        id(color.getTierName() + ItemNames.ARCONIUM_INGOT_SUFFIX),
                        new ItemStack(ModItems.getArconiumIngot(color).get().asItem()),
                        60,
                        Ingredient.of(Items.WARPED_NYLIUM),
                        Ingredient.of(Items.PRISMARINE),
                        Ingredient.of(Items.NETHERITE_SCRAP),
                        Ingredient.of(Items.BLAZE_ROD),
                        essence,
                        essence,
                        essence,
                        clover
                )
        );

        color = RainbowColor.PURPLE;
        essence = Ingredient.of(ModItems.getArconiumEssence(color).get());
        consumer.accept(
                new PedestalFinishedRecipe(
                        id(color.getTierName() + ItemNames.ARCONIUM_INGOT_SUFFIX),
                        new ItemStack(ModItems.getArconiumIngot(color).get().asItem()),
                        60,
                        Ingredient.of(Items.SHULKER_SHELL),
                        Ingredient.of(Items.DRAGON_BREATH),
                        Ingredient.of(Items.PURPUR_BLOCK),
                        Ingredient.of(Items.END_ROD),
                        essence,
                        essence,
                        essence,
                        clover
                )
        );

    }

    private void registerMisc(Consumer<FinishedRecipe> consumer) {
        consumer.accept(
                new PedestalFinishedRecipe(
                        id(ItemNames.GOLD_COIN),
                        new ItemStack(ModItems.goldCoin.get().asItem()),
                        20,
                        Ingredient.of(Items.GOLD_NUGGET)
                )
        );
    }

    private void registerInfiniteGoldArconiumBlocks(Consumer<FinishedRecipe> consumer) {
        RainbowColor.stream().forEach(color -> consumer.accept(makeInfiniteGoldArconiumBlock(color)));
    }

    private static FinishedRecipe makeInfiniteGoldArconiumBlock(RainbowColor color) {
        ItemStack output = new ItemStack(ModBlocks.getInfiniteGoldArconiumBlock(color).get().asItem());
        Ingredient goldBlock = Ingredient.of(Blocks.GOLD_BLOCK.asItem());
        if (color != RainbowColor.RED) {
            goldBlock = Ingredient.of(ModBlocks.getInfiniteGoldArconiumBlock(color.getPreviousTier()).get().asItem());
        }
        Ingredient sapling = Ingredient.of(ModBlocks.getArconiumTreeSapling(color).get().asItem());
        Ingredient clover = Ingredient.of(ModItems.fourLeafClover.get());
        Ingredient dye = Ingredient.of(RainbowColor.dyeByTier(color));
        Item extraItem = RainbowColor.dyeByTier(color);
        switch(color) {
            case YELLOW: extraItem = Items.YELLOW_CANDLE; break;
            case GREEN: extraItem = Items.EMERALD_BLOCK; break;
            case LIGHT_BLUE: extraItem = Items.BLUE_ICE; break;
            case BLUE: extraItem = Items.TUBE_CORAL_BLOCK; break;
            case PURPLE: extraItem = Items.PURPLE_SHULKER_BOX; break;
        }
        ResourceLocation recipeId = id(color.getTierName() + BlockNames.INFINITE_GOLD_ARCONIUM_BLOCK_SUFFIX);
        final int durationTicks = 100;
        return new PedestalFinishedRecipe(recipeId, output, durationTicks, goldBlock, sapling, dye, dye, dye, Ingredient.of(extraItem), clover, clover);
    }


    /**
     * Craft an enchanted colored root for a given item to be generated as part of the resource generation of the mod
     *
     * @param tier             Tier of colored root to make
     * @param resourceItem     The item to be produced by the tree
     * @param durationTicks    time the crafting recipe will take to make the root
     * @param resourceGenCount Number of items to generate per resource generation event
     * @param ingredients
     * @return
     */
    private static FinishedRecipe makeEnchantedColoredRoot(
            RainbowColor tier, ItemLike resourceItem, int durationTicks, int resourceGenCount, Ingredient... ingredients) {
        Item root = ModItems.getColoredRoot(tier).get();
        ItemStack coloredRoot = new ItemStack(root);
        ColoredRoot.setResourceItem(coloredRoot, resourceItem, resourceGenCount);
        ResourceLocation rootId = Registry.ITEM.getKey(root);
        ResourceLocation itemId = Registry.ITEM.getKey(resourceItem.asItem());
        ResourceLocation recipeId = id(rootId.getPath() + "/" + itemId.getNamespace() + "_" + itemId.getPath());
        Arconia.logger.info("***** Recipe ID: " + recipeId);
        Ingredient[] newIngredients = Arrays.copyOf(ingredients, ingredients.length + 1);
        newIngredients[ingredients.length] = Ingredient.of(root);
        return new PedestalFinishedRecipe(recipeId, coloredRoot, durationTicks, newIngredients);
    }

    private static ResourceLocation id(String s) {
        return new ResourceLocation(Arconia.MOD_ID, "pedestal/" + s);
    }


    private static class PedestalFinishedRecipe implements FinishedRecipe {
        private final ResourceLocation id;
        private final ItemStack output;
        private final Ingredient[] inputs;
        private final int durationTicks;

        private PedestalFinishedRecipe(ResourceLocation id, ItemStack output, int durationTicks, Ingredient... inputs) {
            this.id = id;
            this.output = output;
            this.durationTicks = durationTicks;
            this.inputs = inputs;
        }

        @Override
        public void serializeRecipeData(JsonObject json) {
            json.add("output", serializeStack(output));
            json.add("durationTicks", new JsonPrimitive(durationTicks));
            JsonArray ingredients = new JsonArray();
            for (Ingredient ingredient : inputs) {
                ingredients.add(ingredient.toJson());
            }
            json.add("ingredients", ingredients);
        }

        private static JsonObject serializeStack(ItemStack stack) {
            CompoundTag nbt = stack.save(new CompoundTag());
            byte c = nbt.getByte("Count");
            if (c != 1) {
                nbt.putByte("count", c);
            }
            nbt.remove("Count");
            renameTag(nbt, "id", "item");
            renameTag(nbt, "tag", "nbt");
            Dynamic<Tag> dyn = new Dynamic<>(NbtOps.INSTANCE, nbt);
            return dyn.convert(JsonOps.INSTANCE).getValue().getAsJsonObject();
        }

        private static void renameTag(CompoundTag nbt, String oldName, String newName) {
            Tag tag = nbt.get(oldName);
            if (tag != null) {
                nbt.remove(oldName);
                nbt.put(newName, tag);
            }
        }


        @Override
        public ResourceLocation getId() {
            return id;
        }

        @Override
        public RecipeSerializer<?> getType() {
            return ModRecipeTypes.PEDESTAL_SERIALIZER.get();
        }

        @Nullable
        @Override
        public JsonObject serializeAdvancement() {
            return null;
        }

        @Nullable
        @Override
        public ResourceLocation getAdvancementId() {
            return null;
        }
    }
}